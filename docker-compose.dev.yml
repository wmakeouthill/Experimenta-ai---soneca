services:
  # MySQL para desenvolvimento
  mysql-dev:
    image: mysql:8.0
    container_name: snackbar-mysql-dev
    ports:
      - "${MYSQL_PORT:-3307}:3306" # Porta 3307 por padrão para evitar conflito com MySQL local
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_PASSWORD:-dev_password}
      - MYSQL_DATABASE=${DB_NAME:-snackbar_db}
      - MYSQL_USER=${DB_USERNAME:-snackbar_user}
      - MYSQL_PASSWORD=${DB_PASSWORD:-dev_password}
    volumes:
      - mysql_dev_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Backend Spring Boot com hot-reload
  backend-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev.backend
    container_name: snackbar-backend-dev
    ports:
      - "8080:8080"
      - "5005:5005" # Porta para debug remoto Java
    environment:
      - DB_HOST=mysql-dev
      - DB_PORT=3306
      - DB_NAME=${DB_NAME:-snackbar_db}
      - DB_USERNAME=${DB_USERNAME:-snackbar_user}
      - DB_PASSWORD=${DB_PASSWORD:-dev_password}
      - DB_URL=jdbc:mysql://mysql-dev:3306/${DB_NAME:-snackbar_db}?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=America/Sao_Paulo
      - MYSQL_PORT=${MYSQL_PORT:-3307}
      - SERVER_PORT=8080
      - JWT_SECRET=${JWT_SECRET:-dev-jwt-secret-minimo-256-bits-para-desenvolvimento-local}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-86400}
      - SHOW_SQL=${SHOW_SQL:-true}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}
      - SPRING_PROFILES_ACTIVE=dev
    # Nota: Variáveis de ambiente acima têm valores padrão
    # Para usar valores customizados, crie um arquivo .env na raiz do projeto
    volumes:
      # Mapear código fonte para hot-reload
      - ./sistema-orquestrador:/app/sistema-orquestrador
      - ./kernel-compartilhado:/app/kernel-compartilhado
      - ./gestao-cardapio:/app/gestao-cardapio
      - ./gestao-clientes:/app/gestao-clientes
      - ./gestao-pedidos:/app/gestao-pedidos
      - ./autenticacao:/app/autenticacao
      - ./impressao-cupom-fiscal:/app/impressao-cupom-fiscal
      - ./pom.xml:/app/pom.xml
      # Cache do Maven para acelerar builds
      - maven_cache:/root/.m2
    depends_on:
      mysql-dev:
        condition: service_healthy
    restart: unless-stopped

  # Frontend Angular com hot-reload
  frontend-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev.frontend
    container_name: snackbar-frontend-dev
    ports:
      - "4200:4200" # Porta padrão do ng serve
    environment:
      - NODE_ENV=development
    volumes:
      # Mapear código fonte para hot-reload (mas não node_modules)
      - ./frontend:/app/frontend
      # Volume nomeado para node_modules (evita sobrescrever com volume do código)
      - frontend_node_modules:/app/frontend/node_modules
      # Cache do npm para acelerar instalações
      - npm_cache:/root/.npm
    depends_on:
      backend-dev:
        condition: service_started
    restart: unless-stopped

volumes:
  mysql_dev_data:
    driver: local
  maven_cache:
    driver: local
  npm_cache:
    driver: local
  frontend_node_modules:
    driver: local
