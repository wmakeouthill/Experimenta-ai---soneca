<div class="pedido-cliente-container">
    <!-- Carregando Mesa -->
    @if (carregando()) {
        <div class="loading-screen">
            <div class="loading-spinner"></div>
            <p>Carregando...</p>
        </div>
    }

    <!-- Erro -->
    @if (erro() && !carregando()) {
        <div class="error-screen">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2>Oops!</h2>
            <p>{{ erro() }}</p>
        </div>
    }

    <!-- ========== ETAPA 1: IDENTIFICA√á√ÉO ========== -->
    @if (!carregando() && !erro() && etapaAtual() === 'identificacao' && mesa()) {
        <div class="identificacao-screen">
            <div class="identificacao-header">
                <img src="/assets/experimenta_ai_banner_circular.png" alt="Logo" class="logo-grande">
                <h1>Bem-vindo!</h1>
                <p class="mesa-badge">Mesa {{ mesa()!.numero }}</p>
            </div>

            <div class="identificacao-form">
                <h2>Digite seu telefone</h2>
                <p class="form-hint">Usamos para identificar voc√™ e seus pedidos</p>

                <div class="input-group">
                    <input
                        type="tel"
                        [(ngModel)]="telefoneInputValue"
                        placeholder="(00) 00000-0000"
                        class="input-telefone"
                        [class.valido]="identificacao.telefoneValido()"
                        maxlength="15"
                        inputmode="numeric">
                </div>

                @if (identificacao.erro()) {
                    <p class="erro-msg">{{ identificacao.erro() }}</p>
                }

                <button
                    class="btn-continuar"
                    [disabled]="!identificacao.podeBuscar()"
                    (click)="buscarCliente()">
                    @if (identificacao.buscando()) {
                        <span class="spinner-mini"></span> Buscando...
                    } @else {
                        Continuar
                    }
                </button>

                <!-- Divisor -->
                <div class="divisor-ou">
                    <span>ou</span>
                </div>

                <!-- Bot√£o Login Google -->
                <button
                    class="btn-google"
                    [disabled]="googleAuth.clienteAuth.carregando()"
                    (click)="loginComGoogle()">
                    @if (googleAuth.clienteAuth.carregando()) {
                        <span class="spinner-mini"></span> Entrando...
                    } @else {
                        <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Entrar com Google
                    }
                </button>

                @if (googleAuth.clienteAuth.erro()) {
                    <p class="erro-msg">{{ googleAuth.clienteAuth.erro() }}</p>
                }
            </div>
        </div>
    }

    <!-- ========== ETAPA 2: CADASTRO (Novo Cliente) ========== -->
    @if (!carregando() && !erro() && etapaAtual() === 'cadastro' && mesa()) {
        <div class="identificacao-screen">
            <div class="identificacao-header">
                <img src="/assets/experimenta_ai_banner_circular.png" alt="Logo" class="logo-grande">
                <h1>Novo por aqui?</h1>
                <p class="mesa-badge">Mesa {{ mesa()!.numero }}</p>
            </div>

            <div class="identificacao-form">
                <h2>Complete seu cadastro</h2>
                <p class="form-hint">Precisamos de algumas informa√ß√µes para continuar</p>

                <div class="input-group">
                    <label>Telefone</label>
                    <input
                        type="tel"
                        [value]="identificacao.getTelefone()"
                        disabled
                        class="input-telefone disabled">
                </div>

                <div class="input-group">
                    <label>Seu nome</label>
                    <input
                        type="text"
                        [(ngModel)]="nomeInputValue"
                        placeholder="Como podemos te chamar?"
                        class="input-nome"
                        [class.valido]="identificacao.nomeValido()"
                        maxlength="100">
                </div>

                @if (identificacao.erro()) {
                    <p class="erro-msg">{{ identificacao.erro() }}</p>
                }

                <button
                    class="btn-continuar"
                    [disabled]="!identificacao.podeCadastrar()"
                    (click)="cadastrarCliente()">
                    @if (identificacao.buscando()) {
                        <span class="spinner-mini"></span> Cadastrando...
                    } @else {
                        Come√ßar a pedir
                    }
                </button>

                <button class="btn-voltar" (click)="voltarParaIdentificacao()">
                    ‚Üê Voltar
                </button>
            </div>
        </div>
    }

    <!-- ========== ETAPA 3: CARD√ÅPIO ========== -->
    @if (!carregando() && !erro() && etapaAtual() === 'cardapio' && mesa() && identificacao.clienteIdentificado()) {
        <!-- Header fixo -->
        <header class="header-cliente">
            <div class="header-content">
                <img src="/assets/experimenta_ai_banner_circular.png" alt="Logo" class="logo-mini">
                <div class="header-info">
                    <span class="cliente-nome">Ol√°, {{ identificacao.clienteIdentificado()!.nome.split(' ')[0] }}!</span>
                    <span class="mesa-label">Mesa {{ mesa()!.numero }}</span>
                </div>
            </div>
        </header>

        <!-- Carregando card√°pio -->
        @if (cardapio.carregando()) {
            <div class="loading-cardapio">
                <div class="loading-spinner"></div>
                <p>Carregando card√°pio...</p>
            </div>
        } @else {
            <!-- ========== ABA: IN√çCIO ========== -->
            @if (abaAtual() === 'inicio') {
                <div class="aba-inicio">
                    <!-- Mais Pedidos -->
                    <div class="inicio-section">
                        <h2 class="section-titulo">üî• Mais Pedidos</h2>
                        @if (inicio.carregando()) {
                            <div class="carrossel-loading">Carregando...</div>
                        } @else if (inicio.produtosMaisPedidos().length > 0) {
                            <div class="carrossel-horizontal" appDraggableScroll>
                                @for (produto of inicio.produtosMaisPedidos(); track produto.id) {
                                    <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                                        <button
                                            class="btn-favorito"
                                            [class.ativo]="favoritos.isFavorito(produto.id)"
                                            (click)="toggleFavorito(produto.id, $event)"
                                            [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                                            {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                                        </button>
                                        @if (produto.foto) {
                                            <div class="produto-imagem-mini">
                                                <img [src]="produto.foto" [alt]="produto.nome">
                                            </div>
                                        } @else {
                                            <div class="produto-imagem-mini produto-sem-foto">
                                                <span>üçΩÔ∏è</span>
                                            </div>
                                        }
                                        <div class="produto-info-mini">
                                            <span class="produto-nome-mini">{{ produto.nome }}</span>
                                            <span class="produto-preco-mini">{{ formatarPreco(produto.preco) }}</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        } @else {
                            <p class="carrossel-vazio">Nenhum produto ainda. Fa√ßa seu primeiro pedido!</p>
                        }
                    </div>

                    <!-- Favoritos de Sempre (mais favoritados por todos os clientes) -->
                    @if (inicio.temMaisFavoritados()) {
                        <div class="inicio-section">
                            <h2 class="section-titulo">üíñ Favoritos de Sempre</h2>
                            <div class="carrossel-horizontal" appDraggableScroll>
                                @for (produto of inicio.produtosMaisFavoritados(); track produto.id) {
                                    <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                                        <button
                                            class="btn-favorito"
                                            [class.ativo]="favoritos.isFavorito(produto.id)"
                                            (click)="toggleFavorito(produto.id, $event)"
                                            [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                                            {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                                        </button>
                                        @if (produto.foto) {
                                            <div class="produto-imagem-mini">
                                                <img [src]="produto.foto" [alt]="produto.nome">
                                            </div>
                                        } @else {
                                            <div class="produto-imagem-mini produto-sem-foto">
                                                <span>üçΩÔ∏è</span>
                                            </div>
                                        }
                                        <div class="produto-info-mini">
                                            <span class="produto-nome-mini">{{ produto.nome }}</span>
                                            @if (produto.quantidadeFavoritos) {
                                                <span class="produto-pedidos">{{ produto.quantidadeFavoritos }} ‚ù§Ô∏è</span>
                                            }
                                            <span class="produto-preco-mini">{{ formatarPreco(produto.preco) }}</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Mais Bem Avaliados -->
                    <div class="inicio-section">
                        <h2 class="section-titulo">‚≠ê Mais Bem Avaliados</h2>
                        @if (inicio.carregando()) {
                            <div class="carrossel-loading">Carregando...</div>
                        } @else if (inicio.produtosBemAvaliados().length > 0) {
                            <div class="carrossel-horizontal" appDraggableScroll>
                                @for (produto of inicio.produtosBemAvaliados(); track produto.id) {
                                    <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                                        <button
                                            class="btn-favorito"
                                            [class.ativo]="favoritos.isFavorito(produto.id)"
                                            (click)="toggleFavorito(produto.id, $event)"
                                            [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                                            {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                                        </button>
                                        @if (produto.foto) {
                                            <div class="produto-imagem-mini">
                                                <img [src]="produto.foto" [alt]="produto.nome">
                                            </div>
                                        } @else {
                                            <div class="produto-imagem-mini produto-sem-foto">
                                                <span>üçΩÔ∏è</span>
                                            </div>
                                        }
                                        <div class="produto-info-mini">
                                            <span class="produto-nome-mini">{{ produto.nome }}</span>
                                            @if (produto.mediaAvaliacao) {
                                                <span class="produto-avaliacao">‚≠ê {{ produto.mediaAvaliacao.toFixed(1) }}</span>
                                            }
                                            <span class="produto-preco-mini">{{ formatarPreco(produto.preco) }}</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        } @else {
                            <p class="carrossel-vazio">Nenhum produto avaliado ainda.</p>
                        }
                    </div>

                    <!-- Meus Favoritos -->
                    @if (favoritos.produtosFavoritos().length > 0) {
                        <div class="inicio-section">
                            <h2 class="section-titulo">‚ù§Ô∏è Meus Favoritos</h2>
                            <div class="carrossel-horizontal" appDraggableScroll>
                                @for (produto of favoritos.produtosFavoritos(); track produto.id) {
                                    <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                                        <button class="btn-favorito ativo" (click)="toggleFavorito(produto.id, $event)" title="Remover dos favoritos">
                                            ‚ù§Ô∏è
                                        </button>
                                        @if (produto.foto) {
                                            <div class="produto-imagem-mini">
                                                <img [src]="produto.foto" [alt]="produto.nome">
                                            </div>
                                        } @else {
                                            <div class="produto-imagem-mini produto-sem-foto">
                                                <span>üçΩÔ∏è</span>
                                            </div>
                                        }
                                        <div class="produto-info-mini">
                                            <span class="produto-nome-mini">{{ produto.nome }}</span>
                                            <span class="produto-preco-mini">{{ formatarPreco(produto.preco) }}</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <div class="inicio-categorias">
                        <h2 class="section-titulo">üìÇ Categorias</h2>
                        <div class="categorias-grid">
                            @for (categoria of cardapio.categorias(); track categoria.id) {
                                <button class="categoria-card" (click)="cardapio.selecionarCategoria(categoria.nome); navegarPara('cardapio')">
                                    <span class="categoria-nome">{{ categoria.nome }}</span>
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- ========== ABA: CARD√ÅPIO ========== -->
            @if (abaAtual() === 'cardapio') {
            <!-- Categorias -->
            <div class="categorias-scroll">
                <button
                    class="categoria-chip"
                    [class.ativa]="cardapio.categoriaSelecionada() === null"
                    (click)="cardapio.selecionarCategoria(null)">
                    üçΩÔ∏è Todos
                </button>
                @for (categoria of cardapio.categorias(); track categoria.id) {
                    <button
                        class="categoria-chip"
                        [class.ativa]="cardapio.categoriaSelecionada() === categoria.nome"
                        (click)="cardapio.selecionarCategoria(categoria.nome)">
                        {{ categoria.nome }}
                    </button>
                }
            </div>

            <!-- Lista de Produtos -->
            <div class="produtos-container">
                <!-- Exibi√ß√£o agrupada por categoria (quando "Todos" selecionado) -->
                @if (cardapio.categoriaSelecionada() === null) {
                    @for (grupo of cardapio.produtosAgrupadosPorCategoria(); track grupo.id) {
                        <div class="categoria-section">
                            <h2 class="categoria-titulo">{{ grupo.nome }}</h2>
                            <div class="produtos-grid">
                                @for (produto of grupo.produtos; track produto.id) {
                                    <div class="produto-card" (click)="abrirDetalhesProduto(produto)">
                                        @if (produto.foto) {
                                            <div class="produto-imagem">
                                                <img [src]="produto.foto" [alt]="produto.nome">
                                            </div>
                                        } @else {
                                            <div class="produto-imagem produto-sem-foto">
                                                <span>üçΩÔ∏è</span>
                                            </div>
                                        }
                                        <div class="produto-info">
                                            <h3 class="produto-nome">{{ produto.nome }}</h3>
                                            @if (produto.descricao) {
                                                <p class="produto-descricao">{{ produto.descricao }}</p>
                                            }
                                            <div class="produto-preco">{{ formatarPreco(produto.preco) }}</div>
                                        </div>
                                        <button class="btn-adicionar">+</button>
                                    </div>
                                }
                            </div>
                        </div>
                    } @empty {
                        <div class="sem-produtos">
                            <p>Nenhum produto dispon√≠vel</p>
                        </div>
                    }
                } @else {
                    <!-- Exibi√ß√£o normal (categoria espec√≠fica selecionada) -->
                    <div class="produtos-grid">
                        @for (produto of cardapio.produtosFiltrados(); track produto.id) {
                            <div class="produto-card" (click)="abrirDetalhesProduto(produto)">
                                @if (produto.foto) {
                                    <div class="produto-imagem">
                                        <img [src]="produto.foto" [alt]="produto.nome">
                                    </div>
                                } @else {
                                    <div class="produto-imagem produto-sem-foto">
                                        <span>üçΩÔ∏è</span>
                                    </div>
                                }
                                <div class="produto-info">
                                    <h3 class="produto-nome">{{ produto.nome }}</h3>
                                    @if (produto.descricao) {
                                        <p class="produto-descricao">{{ produto.descricao }}</p>
                                    }
                                    <div class="produto-preco">{{ formatarPreco(produto.preco) }}</div>
                                </div>
                                <button class="btn-adicionar">+</button>
                            </div>
                        } @empty {
                            <div class="sem-produtos">
                                <p>Nenhum produto dispon√≠vel nesta categoria</p>
                            </div>
                        }
                    </div>
                }
            </div>
            } <!-- Fecha @if abaAtual() === 'cardapio' -->

            <!-- ========== ABA: PERFIL ========== -->
            @if (abaAtual() === 'perfil') {
                <div class="aba-perfil">
                    <div class="perfil-header">
                        <div class="perfil-avatar">
                            @if (googleAuth.clienteAuth.cliente()?.fotoUrl) {
                                <img [src]="googleAuth.clienteAuth.cliente()!.fotoUrl"
                                     alt="Foto"
                                     class="avatar-img"
                                     (error)="onImageError($event)">
                            } @else {
                                <span class="avatar-placeholder">üë§</span>
                            }
                        </div>
                        <h2 class="perfil-nome">{{ identificacao.clienteIdentificado()!.nome }}</h2>
                        @if (identificacao.clienteIdentificado()!.telefone) {
                            <p class="perfil-telefone">{{ formatarTelefone(identificacao.clienteIdentificado()!.telefone) }}</p>
                        }
                        @if (googleAuth.clienteAuth.cliente()?.email) {
                            <p class="perfil-email">{{ googleAuth.clienteAuth.cliente()!.email }}</p>
                        }
                    </div>

                    <div class="perfil-menu">
                        <!-- Vincular/Desvincular Google -->
                        @if (googleAuth.clienteAuth.cliente()?.googleVinculado) {
                            <button class="perfil-item google-vinculado" (click)="desvincularGoogle()">
                                <span class="item-icon">
                                    <svg viewBox="0 0 24 24" width="20" height="20">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                </span>
                                <span class="item-texto">Google vinculado</span>
                                <span class="item-badge vinculado">‚úì</span>
                            </button>
                        } @else {
                            <button class="perfil-item google-vincular" (click)="vincularGoogle()" [disabled]="googleAuth.clienteAuth.carregando()">
                                <span class="item-icon">
                                    <svg viewBox="0 0 24 24" width="20" height="20">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                    </svg>
                                </span>
                                <span class="item-texto">Vincular com Google</span>
                                <span class="item-arrow">‚Ä∫</span>
                            </button>
                        }

                        <button class="perfil-item" (click)="trocarCliente()">
                            <span class="item-icon">üîÑ</span>
                            <span class="item-texto">Trocar conta</span>
                            <span class="item-arrow">‚Ä∫</span>
                        </button>
                        <button class="perfil-item disabled">
                            <span class="item-icon">‚≠ê</span>
                            <span class="item-texto">Favoritos</span>
                            <span class="item-badge">Em breve</span>
                        </button>
                        <button class="perfil-item disabled">
                            <span class="item-icon">üìã</span>
                            <span class="item-texto">Meus Pedidos</span>
                            <span class="item-badge">Em breve</span>
                        </button>
                        <button class="perfil-item disabled">
                            <span class="item-icon">üîí</span>
                            <span class="item-texto">Criar Senha</span>
                            <span class="item-badge">Em breve</span>
                        </button>
                    </div>

                    @if (googleAuth.clienteAuth.erro()) {
                        <p class="erro-msg">{{ googleAuth.clienteAuth.erro() }}</p>
                    }

                    <p class="perfil-info">Mesa {{ mesa()!.numero }}</p>
                </div>
            }
        }

        <!-- ========== FOOTER NAVEGA√á√ÉO ========== -->
        <nav class="footer-nav">
            <button class="nav-item" [class.ativo]="abaAtual() === 'inicio'" (click)="navegarPara('inicio')">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">In√≠cio</span>
            </button>
            <button class="nav-item" [class.ativo]="abaAtual() === 'cardapio'" (click)="navegarPara('cardapio')">
                <span class="nav-icon">üìã</span>
                <span class="nav-label">Card√°pio</span>
            </button>
            <button class="nav-item carrinho-nav" [class.ativo]="carrinho.mostrarCarrinho()" (click)="navegarPara('carrinho')">
                <span class="nav-icon">üõí</span>
                @if (carrinho.totalItens() > 0) {
                    <span class="carrinho-badge">{{ carrinho.totalItens() }}</span>
                }
                <span class="nav-label">Carrinho</span>
            </button>
            <button class="nav-item" [class.ativo]="abaAtual() === 'perfil'" (click)="navegarPara('perfil')">
                <span class="nav-icon">üë§</span>
                <span class="nav-label">Perfil</span>
            </button>
        </nav>
    }

    <!-- ========== ETAPA 4: SUCESSO ========== -->
    @if (etapaAtual() === 'sucesso') {
        <div class="success-screen">
            @if (sucesso.pedidoCancelado()) {
                <!-- Pedido cancelado/rejeitado -->
                <div class="success-icon cancelado">‚ùå</div>
                <h2>Pedido Cancelado</h2>
                <p class="success-main">Infelizmente seu pedido foi cancelado.</p>
                @if (sucesso.statusPedido()?.motivoCancelamento) {
                    <p class="motivo-cancelamento">
                        Motivo: {{ sucesso.statusPedido()?.motivoCancelamento }}
                    </p>
                }
            } @else {
                <!-- Pedido em andamento -->
                <div class="success-icon">üçΩÔ∏è</div>
                @if (sucesso.numeroPedido()) {
                    <h2>Pedido #{{ sucesso.numeroPedido() }}</h2>
                } @else {
                    <h2>Pedido Recebido!</h2>
                }
                <p class="success-main">{{ sucesso.statusDescricao() }}</p>

                <div class="success-steps">
                    <!-- Passo 1: Pedido enviado (sempre completo) -->
                    <div class="step completed">
                        <span class="step-icon">‚úÖ</span>
                        <span>Pedido enviado</span>
                    </div>

                    <!-- Passo 2: Aguardando confirma√ß√£o -->
                    <div class="step"
                         [class.completed]="sucesso.passoAtual() > 1"
                         [class.waiting]="sucesso.passoAtual() === 1">
                        @if (sucesso.passoAtual() > 1) {
                            <span class="step-icon">‚úÖ</span>
                        } @else {
                            <span class="step-icon">‚è≥</span>
                        }
                        <span>Aguardando confirma√ß√£o</span>
                    </div>

                    <!-- Passo 3: Em prepara√ß√£o -->
                    <div class="step"
                         [class.completed]="sucesso.passoAtual() > 2"
                         [class.waiting]="sucesso.passoAtual() === 2"
                         [class.pending]="sucesso.passoAtual() < 2">
                        @if (sucesso.passoAtual() > 2) {
                            <span class="step-icon">‚úÖ</span>
                        } @else if (sucesso.passoAtual() === 2) {
                            <span class="step-icon">üë®‚Äçüç≥</span>
                        } @else {
                            <span class="step-icon">‚è∏Ô∏è</span>
                        }
                        <span>Em prepara√ß√£o</span>
                    </div>

                    <!-- Passo 4: Pronto -->
                    <div class="step"
                         [class.completed]="sucesso.passoAtual() >= 3"
                         [class.pending]="sucesso.passoAtual() < 3">
                        @if (sucesso.passoAtual() >= 3) {
                            <span class="step-icon">üéâ</span>
                        } @else {
                            <span class="step-icon">‚è∏Ô∏è</span>
                        }
                        <span>Pronto!</span>
                    </div>
                </div>

                @if (sucesso.pedidoFinalizado()) {
                    <p class="success-info pronto">
                        üéâ Seu pedido est√° pronto!<br>
                        Aguarde que iremos servir na mesa {{ mesa()?.numero }}.
                    </p>
                } @else {
                    <p class="success-info">
                        @if (sucesso.passoAtual() === 1) {
                            Um atendente ir√° confirmar seu pedido em breve.
                        } @else {
                            Seu pedido est√° sendo preparado.
                        }
                        <br>
                        Fique √† vontade na mesa {{ mesa()?.numero }}!
                    </p>
                    <p class="tempo-espera">
                        ‚è±Ô∏è Tempo de espera: {{ sucesso.formatarTempoEspera() }}
                    </p>
                }
            }

            <button class="btn-novo-pedido" (click)="novoPedido()">
                Fazer Novo Pedido
            </button>
        </div>
    }

    <!-- ========== MODAL: DETALHES DO PRODUTO ========== -->
    @if (carrinho.mostrarDetalhes() && carrinho.produtoSelecionado()) {
        <div class="modal-overlay" (click)="carrinho.fecharDetalhes()">
            <div class="modal-produto" (click)="$event.stopPropagation()">
                <button class="btn-fechar-modal" (click)="carrinho.fecharDetalhes()">√ó</button>

                @if (carrinho.produtoSelecionado()!.foto) {
                    <div class="modal-produto-imagem">
                        <img [src]="carrinho.produtoSelecionado()!.foto" [alt]="carrinho.produtoSelecionado()!.nome">
                    </div>
                }

                <div class="modal-produto-content">
                    <h2>{{ carrinho.produtoSelecionado()!.nome }}</h2>
                    @if (carrinho.produtoSelecionado()!.descricao) {
                        <p class="modal-descricao">{{ carrinho.produtoSelecionado()!.descricao }}</p>
                    }
                    <div class="modal-preco">{{ formatarPreco(carrinho.produtoSelecionado()!.preco) }}</div>

                    <div class="observacao-container">
                        <label>Alguma observa√ß√£o?</label>
                        <textarea
                            [(ngModel)]="observacaoTempValue"
                            placeholder="Ex: Sem cebola, bem passado..."
                            rows="2">
                        </textarea>
                    </div>

                    <div class="quantidade-controle">
                        <button class="btn-quantidade" (click)="carrinho.decrementarQuantidade()" [disabled]="carrinho.quantidadeTemp() <= 1">‚àí</button>
                        <span class="quantidade-valor">{{ carrinho.quantidadeTemp() }}</span>
                        <button class="btn-quantidade" (click)="carrinho.incrementarQuantidade()">+</button>
                    </div>

                    <button class="btn-adicionar-carrinho" (click)="carrinho.adicionarAoCarrinho()">
                        Adicionar ‚Ä¢ {{ formatarPreco(carrinho.produtoSelecionado()!.preco * carrinho.quantidadeTemp()) }}
                    </button>
                </div>
            </div>
        </div>
    }

    <!-- ========== MODAL: CARRINHO ========== -->
    @if (carrinho.mostrarCarrinho()) {
        <div class="modal-overlay carrinho-overlay" (click)="fecharCarrinho()">
            <div class="modal-carrinho" (click)="$event.stopPropagation()">
                <div class="carrinho-header">
                    @if (pagamento.etapa() === 'itens') {
                        <h2>Seu Pedido</h2>
                    } @else if (pagamento.etapa() === 'pagamento') {
                        <button class="btn-voltar-carrinho" (click)="pagamento.voltarParaItens()">‚Üê</button>
                        <h2>Pagamento</h2>
                    } @else if (pagamento.etapa() === 'confirmacao') {
                        <button class="btn-voltar-carrinho" (click)="pagamento.voltarParaPagamento()">‚Üê</button>
                        <h2>Confirmar</h2>
                    }
                    <button class="btn-fechar-modal" (click)="fecharCarrinho()">√ó</button>
                </div>

                <!-- ========== ETAPA 1: ITENS ========== -->
                @if (pagamento.etapa() === 'itens') {
                <div class="carrinho-content">
                    @if (carrinho.itens().length === 0) {
                        <div class="carrinho-vazio">
                            <span>üõí</span>
                            <p>Seu carrinho est√° vazio</p>
                        </div>
                    } @else {
                        <!-- Info do cliente -->
                        @if (identificacao.clienteIdentificado()) {
                            <div class="carrinho-cliente-info">
                                @if (identificacao.clienteIdentificado()!.fotoUrl) {
                                    <img
                                        [src]="identificacao.clienteIdentificado()!.fotoUrl"
                                        alt="Foto do cliente"
                                        class="cliente-foto"
                                        referrerpolicy="no-referrer"
                                    />
                                } @else {
                                    <span class="cliente-icone">üë§</span>
                                }
                                <div class="cliente-dados">
                                    <strong>{{ identificacao.clienteIdentificado()!.nome }}</strong>
                                    <span>{{ formatarTelefone(identificacao.clienteIdentificado()!.telefone) }}</span>
                                </div>
                            </div>
                        }

                        <div class="carrinho-itens">
                            @for (item of carrinho.itens(); track item.produto.id) {
                                <div class="carrinho-item">
                                    <div class="item-info">
                                        <h4>{{ item.produto.nome }}</h4>
                                        @if (item.observacao) {
                                            <p class="item-obs">{{ item.observacao }}</p>
                                        }
                                        <span class="item-preco">{{ formatarPreco(item.produto.preco * item.quantidade) }}</span>
                                    </div>
                                    <div class="item-controles">
                                        <button class="btn-qty-mini" (click)="carrinho.alterarQuantidade(item.produto.id, -1)">‚àí</button>
                                        <span class="qty-mini">{{ item.quantidade }}</span>
                                        <button class="btn-qty-mini" (click)="carrinho.alterarQuantidade(item.produto.id, 1)">+</button>
                                    </div>
                                    <button class="btn-remover" (click)="carrinho.removerDoCarrinho(item.produto.id)">üóëÔ∏è</button>
                                </div>
                            }
                        </div>

                        <div class="carrinho-total">
                            <span>Total</span>
                            <strong>{{ formatarPreco(carrinho.totalValor()) }}</strong>
                        </div>
                    }
                </div>

                <div class="carrinho-footer">
                    <button
                        class="btn-enviar-pedido"
                        [disabled]="!podeEnviarPedido()"
                        (click)="pagamento.avancarParaPagamento()">
                        Escolher Pagamento
                    </button>
                </div>
                }

                <!-- ========== ETAPA 2: PAGAMENTO ========== -->
                @if (pagamento.etapa() === 'pagamento') {
                <div class="carrinho-content pagamento-content">
                    <div class="pagamento-total-header">
                        <span>Total a pagar</span>
                        <strong>{{ formatarPreco(carrinho.totalValor()) }}</strong>
                    </div>

                    <!-- Toggle para dividir pagamento -->
                    <div class="pagamento-dividir">
                        <label class="toggle-dividir">
                            <input type="checkbox" [checked]="pagamento.dividido()" (change)="pagamento.toggleDividido()">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Dividir pagamento</span>
                        </label>
                    </div>

                    <!-- Op√ß√µes de pagamento -->
                    <div class="pagamento-opcoes">
                        <h3>Como deseja pagar?</h3>

                        <!-- PIX -->
                        <div class="pagamento-opcao"
                             [class.selecionado]="pagamento.meioPagamentoSelecionado('PIX')"
                             (click)="pagamento.selecionarMeio('PIX')">
                            <div class="opcao-info">
                                <span class="opcao-icone">üì±</span>
                                <span class="opcao-nome">PIX</span>
                            </div>
                            @if (pagamento.dividido() && pagamento.meioPagamentoSelecionado('PIX')) {
                                <div class="opcao-valor" (click)="$event.stopPropagation()">
                                    <span>R$</span>
                                    <input type="number"
                                           [value]="pagamento.getValorMeio('PIX')"
                                           (input)="pagamento.atualizarValorMeio('PIX', $any($event.target).valueAsNumber || 0)"
                                           min="0"
                                           step="0.01">
                                </div>
                            }
                            @if (!pagamento.dividido() && pagamento.meioPagamentoSelecionado('PIX')) {
                                <span class="opcao-check">‚úì</span>
                            }
                        </div>

                        <!-- Cart√£o de Cr√©dito -->
                        <div class="pagamento-opcao"
                             [class.selecionado]="pagamento.meioPagamentoSelecionado('CARTAO_CREDITO')"
                             (click)="pagamento.selecionarMeio('CARTAO_CREDITO')">
                            <div class="opcao-info">
                                <span class="opcao-icone">üí≥</span>
                                <span class="opcao-nome">Cart√£o de Cr√©dito</span>
                            </div>
                            @if (pagamento.dividido() && pagamento.meioPagamentoSelecionado('CARTAO_CREDITO')) {
                                <div class="opcao-valor" (click)="$event.stopPropagation()">
                                    <span>R$</span>
                                    <input type="number"
                                           [value]="pagamento.getValorMeio('CARTAO_CREDITO')"
                                           (input)="pagamento.atualizarValorMeio('CARTAO_CREDITO', $any($event.target).valueAsNumber || 0)"
                                           min="0"
                                           step="0.01">
                                </div>
                            }
                            @if (!pagamento.dividido() && pagamento.meioPagamentoSelecionado('CARTAO_CREDITO')) {
                                <span class="opcao-check">‚úì</span>
                            }
                        </div>

                        <!-- Cart√£o de D√©bito -->
                        <div class="pagamento-opcao"
                             [class.selecionado]="pagamento.meioPagamentoSelecionado('CARTAO_DEBITO')"
                             (click)="pagamento.selecionarMeio('CARTAO_DEBITO')">
                            <div class="opcao-info">
                                <span class="opcao-icone">üí≥</span>
                                <span class="opcao-nome">Cart√£o de D√©bito</span>
                            </div>
                            @if (pagamento.dividido() && pagamento.meioPagamentoSelecionado('CARTAO_DEBITO')) {
                                <div class="opcao-valor" (click)="$event.stopPropagation()">
                                    <span>R$</span>
                                    <input type="number"
                                           [value]="pagamento.getValorMeio('CARTAO_DEBITO')"
                                           (input)="pagamento.atualizarValorMeio('CARTAO_DEBITO', $any($event.target).valueAsNumber || 0)"
                                           min="0"
                                           step="0.01">
                                </div>
                            }
                            @if (!pagamento.dividido() && pagamento.meioPagamentoSelecionado('CARTAO_DEBITO')) {
                                <span class="opcao-check">‚úì</span>
                            }
                        </div>

                        <!-- Dinheiro -->
                        <div class="pagamento-opcao"
                             [class.selecionado]="pagamento.meioPagamentoSelecionado('DINHEIRO')"
                             (click)="pagamento.selecionarMeio('DINHEIRO')">
                            <div class="opcao-info">
                                <span class="opcao-icone">üíµ</span>
                                <span class="opcao-nome">Dinheiro</span>
                            </div>
                            @if (pagamento.dividido() && pagamento.meioPagamentoSelecionado('DINHEIRO')) {
                                <div class="opcao-valor" (click)="$event.stopPropagation()">
                                    <span>R$</span>
                                    <input type="number"
                                           [value]="pagamento.getValorMeio('DINHEIRO')"
                                           (input)="pagamento.atualizarValorMeio('DINHEIRO', $any($event.target).valueAsNumber || 0)"
                                           min="0"
                                           step="0.01">
                                </div>
                            }
                            @if (!pagamento.dividido() && pagamento.meioPagamentoSelecionado('DINHEIRO')) {
                                <span class="opcao-check">‚úì</span>
                            }
                        </div>
                    </div>

                    <!-- Resumo do pagamento dividido -->
                    @if (pagamento.dividido() && pagamento.meiosSelecionados().length > 0) {
                        <div class="pagamento-resumo">
                            <div class="resumo-linha">
                                <span>Total alocado</span>
                                <span [class.valor-ok]="pagamento.pagamentoValido()" [class.valor-erro]="!pagamento.pagamentoValido()">
                                    {{ formatarPreco(pagamento.totalAlocado()) }}
                                </span>
                            </div>
                            @if (pagamento.valorRestante() > 0.01) {
                                <div class="resumo-linha restante">
                                    <span>Falta alocar</span>
                                    <span class="valor-erro">{{ formatarPreco(pagamento.valorRestante()) }}</span>
                                </div>
                            }
                            @if (pagamento.valorRestante() < -0.01) {
                                <div class="resumo-linha excedente">
                                    <span>Valor excedente</span>
                                    <span class="valor-erro">{{ formatarPreco(Math.abs(pagamento.valorRestante())) }}</span>
                                </div>
                            }
                        </div>
                    }
                </div>

                <div class="carrinho-footer">
                    <button
                        class="btn-enviar-pedido"
                        [disabled]="!pagamento.pagamentoValido()"
                        (click)="pagamento.irParaConfirmacao()">
                        Revisar Pedido
                    </button>
                </div>
                }

                <!-- ========== ETAPA 3: CONFIRMA√á√ÉO ========== -->
                @if (pagamento.etapa() === 'confirmacao') {
                <div class="carrinho-content confirmacao-content">
                    <div class="confirmacao-header">
                        <span class="confirmacao-icone">üìã</span>
                        <h3 class="confirmacao-titulo">Revise seu pedido</h3>
                        <p class="confirmacao-subtitulo">Confira os detalhes antes de enviar</p>
                    </div>

                    <div class="resumo-pedido">
                        <!-- Cliente -->
                        @if (identificacao.clienteIdentificado()) {
                            <div class="resumo-secao">
                                <span class="resumo-secao-titulo">Cliente</span>
                                <div class="resumo-cliente-info">
                                    <span class="cliente-nome-resumo">{{ identificacao.clienteIdentificado()!.nome }}</span>
                                    <span class="cliente-telefone-resumo">{{ formatarTelefone(identificacao.clienteIdentificado()!.telefone) }}</span>
                                </div>
                            </div>
                        }

                        <!-- Itens -->
                        <div class="resumo-secao">
                            <span class="resumo-secao-titulo">Itens ({{ carrinho.itens().length }})</span>
                            @for (item of carrinho.itens(); track item.produto.id) {
                                <div class="resumo-item-pedido">
                                    <div class="item-qtd-nome">
                                        <span class="item-qtd-badge">{{ item.quantidade }}x</span>
                                        <span class="item-nome-resumo">{{ item.produto.nome }}</span>
                                    </div>
                                    <span class="item-valor-resumo">{{ formatarPreco(item.produto.preco * item.quantidade) }}</span>
                                </div>
                            }
                        </div>

                        <!-- Pagamento -->
                        <div class="resumo-secao">
                            <span class="resumo-secao-titulo">Pagamento</span>
                            @for (pag of pagamento.meiosSelecionados(); track pag.tipo) {
                                <div class="resumo-pagamento-item">
                                    <span class="pagamento-metodo">
                                        <span>{{ pagamento.getIconeMeio(pag.tipo) }}</span>
                                        <span>{{ pagamento.getNomeMeio(pag.tipo) }}</span>
                                    </span>
                                    <span class="pagamento-valor-resumo">{{ formatarPreco(pag.valor) }}</span>
                                </div>
                            }
                        </div>

                        <!-- Total -->
                        <div class="resumo-total-final">
                            <span class="total-label">Total</span>
                            <span class="total-valor-final">{{ formatarPreco(carrinho.totalValor()) }}</span>
                        </div>
                    </div>
                </div>

                <div class="carrinho-footer confirmacao-footer">
                    <button class="btn-editar-pedido" (click)="pagamento.voltarParaPagamento()">
                        ‚úèÔ∏è Editar
                    </button>
                    <button
                        class="btn-enviar-pedido btn-confirmar-final"
                        [disabled]="enviando()"
                        (click)="enviarPedido()">
                        @if (enviando()) {
                            Enviando...
                        } @else {
                            ‚úì Confirmar Pedido
                        }
                    </button>
                </div>
                }
            </div>
        </div>
    }
</div>
