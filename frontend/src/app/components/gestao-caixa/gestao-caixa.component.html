<div class="caixa-container">
  <header class="caixa-header">
    <div class="caixa-header-content">
      <h1 class="caixa-titulo">
        <img src="/assets/experimenta_ai_banner_circular.png" alt="Experimenta a√≠" class="caixa-logo" />
        üíµ Gest√£o de Caixa
      </h1>
      
      <div class="header-right">
        <!-- Cards de Diferen√ßas no Header -->
        @if (resumoCaixa()) {
          <div class="header-diferencas">
            <!-- Diferen√ßa da Sess√£o Atual -->
            @if (resumoCaixa()?.valorFechamento !== null && resumoCaixa()?.valorFechamento !== undefined) {
              <div class="card-diferenca-header" [class.positiva]="(calcularDiferencaAtual()) >= 0" [class.negativa]="(calcularDiferencaAtual()) < 0">
                <span class="card-dif-label">üìä Atual</span>
                <span class="card-dif-valor">{{ formatarMoedaComSinal(calcularDiferencaAtual()) }}</span>
              </div>
            } @else {
              <div class="card-diferenca-header neutro">
                <span class="card-dif-label">üìä Atual</span>
                <span class="card-dif-valor">-</span>
              </div>
            }

            <!-- Diferen√ßa da Sess√£o Anterior -->
            @if (resumoCaixa()?.diferencaSessaoAnterior !== null && resumoCaixa()?.diferencaSessaoAnterior !== undefined) {
              <div class="card-diferenca-header" [class.positiva]="(resumoCaixa()?.diferencaSessaoAnterior ?? 0) >= 0" [class.negativa]="(resumoCaixa()?.diferencaSessaoAnterior ?? 0) < 0">
                <span class="card-dif-label">‚èÆÔ∏è Anterior</span>
                <span class="card-dif-valor">{{ formatarMoedaComSinal(resumoCaixa()?.diferencaSessaoAnterior) }}</span>
              </div>
            } @else {
              <div class="card-diferenca-header neutro">
                <span class="card-dif-label">‚èÆÔ∏è Anterior</span>
                <span class="card-dif-valor">-</span>
              </div>
            }

            <!-- Diferen√ßa Global -->
            <div class="card-diferenca-header card-global" [class.positiva]="(resumoCaixa()?.diferencaGlobal ?? 0) >= 0" [class.negativa]="(resumoCaixa()?.diferencaGlobal ?? 0) < 0">
              <span class="card-dif-label">üåç Global</span>
              <span class="card-dif-valor">{{ formatarMoedaComSinal(resumoCaixa()?.diferencaGlobal) }}</span>
            </div>
          </div>
        }

        <div class="header-actions">
          <button class="btn-voltar" routerLink="/" aria-label="Voltar para home">
            ‚Üê Voltar
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="caixa-layout">
    <!-- Sidebar de Sess√µes -->
    <aside class="sidebar-sessoes">
      <div class="sessoes-container">
        <h2 class="sessoes-titulo">üìÖ Sess√µes</h2>

        @if (estaCarregando() && sessoes().length === 0) {
          <div class="estado-carregando-sidebar">
            <div class="spinner-small"></div>
            <p>Carregando...</p>
          </div>
        }

        @if (estado() === 'erro' && sessoes().length === 0) {
          <div class="estado-erro-sidebar">
            <p>{{ erro() }}</p>
            <button class="btn-recarregar-small" (click)="recarregar()">Tentar novamente</button>
          </div>
        }

        @if (sessoes().length === 0 && estado() === 'sucesso') {
          <div class="estado-vazio-sidebar">
            <p>Nenhuma sess√£o encontrada.</p>
          </div>
        }

        <div class="sessoes-lista">
          @for (sessao of sessoes(); track sessao.id) {
            <button
              class="sessao-item"
              [class.sessao-selecionada]="sessaoSelecionada()?.id === sessao.id"
              [class.sessao-aberta]="sessao.status === StatusSessao.ABERTA"
              [class.sessao-pausada]="sessao.status === StatusSessao.PAUSADA"
              [class.sessao-finalizada]="sessao.status === StatusSessao.FINALIZADA"
              (click)="selecionarSessao(sessao)"
            >
              <div class="sessao-item-info">
                <span class="sessao-item-nome">{{ sessao.nome }}</span>
              </div>
              <span class="sessao-item-status" [class]="'status-' + sessao.status.toLowerCase()">
                {{ sessao.status }}
              </span>
            </button>
          }
        </div>
      </div>
    </aside>

    <!-- Conte√∫do Principal -->
    <main class="caixa-main">
      @if (!temSessaoSelecionada()) {
        <div class="estado-inicial">
          <div class="estado-inicial-icone">üí∞</div>
          <h2>Selecione uma Sess√£o</h2>
          <p>Escolha uma sess√£o de trabalho na lista ao lado para visualizar os dados do caixa.</p>
        </div>
      }

      @if (temSessaoSelecionada() && estaCarregando()) {
        <div class="estado-carregando">
          <div class="spinner"></div>
          <p>Carregando dados do caixa...</p>
        </div>
      }

      @if (temSessaoSelecionada() && estado() === 'erro') {
        <div class="estado-erro">
          <p class="erro-mensagem">{{ erro() }}</p>
          <button class="btn-recarregar" (click)="recarregar()">Tentar novamente</button>
        </div>
      }

      @if (temSessaoSelecionada() && estado() === 'sucesso' && resumoCaixa()) {
        <!-- Header Compacto da Sess√£o -->
        <div class="sessao-header-compacto">
          <div class="sessao-info-compacto">
            <span class="sessao-nome-compacto">{{ resumoCaixa()?.nomeSessao }}</span>
            <span class="sessao-status-compacto" [class]="'status-' + sessaoSelecionada()?.status?.toLowerCase()">
              {{ sessaoSelecionada()?.status }}
            </span>
          </div>
          <button class="btn-limpar-compacto" (click)="limparSelecao()">‚úï</button>
        </div>

        <!-- Cards de Resumo Compactos -->
        <div class="resumo-cards-compacto">
          <div class="card-compacto card-abertura">
            <span class="card-label-compacto">üîì Abertura</span>
            <span class="card-valor-compacto">{{ formatarMoeda(resumoCaixa()?.valorAbertura) }}</span>
          </div>

          <div class="card-compacto card-vendas">
            <span class="card-label-compacto">üíµ Vendas ({{ resumoCaixa()?.quantidadeVendasDinheiro }})</span>
            <span class="card-valor-compacto">{{ formatarMoeda(resumoCaixa()?.totalVendasDinheiro) }}</span>
          </div>

          <div class="card-compacto card-suprimentos">
            <span class="card-label-compacto">üì• Suprimentos</span>
            <span class="card-valor-compacto valor-positivo">+{{ formatarMoeda(resumoCaixa()?.totalSuprimentos) }}</span>
          </div>

          <div class="card-compacto card-sangrias">
            <span class="card-label-compacto">üì§ Sangrias</span>
            <span class="card-valor-compacto valor-negativo">-{{ formatarMoeda(resumoCaixa()?.totalSangrias) }}</span>
          </div>

          <div class="card-compacto card-esperado">
            <span class="card-label-compacto">üéØ Saldo Esperado</span>
            <span class="card-valor-compacto">{{ formatarMoeda(calcularSaldoEsperado()) }}</span>
          </div>

          @if (resumoCaixa()?.valorFechamento !== null && resumoCaixa()?.valorFechamento !== undefined) {
            <div class="card-compacto card-fechamento">
              <span class="card-label-compacto">üîí Fechamento</span>
              <span class="card-valor-compacto">{{ formatarMoeda(resumoCaixa()?.valorFechamento) }}</span>
            </div>

            <div class="card-compacto card-diferenca" [class.diferenca-positiva]="(resumoCaixa()?.diferenca ?? 0) >= 0" [class.diferenca-negativa]="(resumoCaixa()?.diferenca ?? 0) < 0">
              <span class="card-label-compacto">üìä Diferen√ßa</span>
              <span class="card-valor-compacto">{{ formatarMoeda(resumoCaixa()?.diferenca) }}</span>
            </div>
          }
        </div>

        <!-- A√ß√µes do Caixa -->
        @if (sessaoEstaAberta()) {
          <div class="caixa-acoes-compacto">
            <button class="btn-acao-compacto btn-sangria" (click)="abrirModalSangria()">
              üì§ Sangria
            </button>
            <button class="btn-acao-compacto btn-suprimento" (click)="abrirModalSuprimento()">
              üì• Suprimento
            </button>
          </div>
        }

        <!-- Tabela de Movimenta√ß√µes (estilo relat√≥rio financeiro) -->
        <section #tabelaCaixa class="tabela-caixa-section">
          <h2 class="tabela-titulo">Movimenta√ß√µes em Dinheiro</h2>

          @if (itensPaginados().totalItens === 0) {
            <div class="tabela-vazia">
              <p>Nenhuma movimenta√ß√£o em dinheiro registrada nesta sess√£o.</p>
            </div>
          }

          @if (itensPaginados().totalItens > 0) {
            <div class="tabela-wrapper">
              <table class="tabela tabela-caixa">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Descri√ß√£o</th>
                    <th>Usu√°rio</th>
                    <th>Data/Hora</th>
                    <th class="text-right">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of itensPaginados().itens; track item.id) {
                    <tr [class]="obterClasseTipo(item.tipo)">
                      <td>
                        <span class="badge-tipo" [class]="'badge-' + item.tipo.toLowerCase()">
                          {{ item.tipoDescricao }}
                        </span>
                      </td>
                      <td>
                        @if (item.tipo === TipoItemCaixa.VENDA_DINHEIRO) {
                          <span class="item-descricao">
                            <strong>#{{ item.numeroPedido }}</strong> - {{ item.clienteNome }}
                          </span>
                        } @else {
                          <span class="item-descricao">{{ item.descricao || '-' }}</span>
                        }
                      </td>
                      <td>
                        <span class="item-usuario">{{ item.usuarioNome || 'Desconhecido' }}</span>
                      </td>
                      <td>{{ formatarDataHora(item.dataHora) }}</td>
                      <td class="text-right">
                        <span class="item-valor" [class.valor-positivo]="item.valor > 0" [class.valor-negativo]="item.valor < 0">
                          {{ item.valor >= 0 ? '+' : '' }}{{ formatarMoeda(item.valor) }}
                        </span>
                      </td>
                    </tr>
                  }
                </tbody>
                <tfoot>
                  <tr class="tabela-total">
                    <td colspan="4"><strong>Total em Dinheiro</strong></td>
                    <td class="text-right"><strong>{{ formatarMoeda(calcularTotalDinheiro()) }}</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <!-- Pagina√ß√£o -->
            @if (itensPaginados().totalPaginas > 1) {
              <div class="paginacao">
                <button
                  class="btn-paginacao"
                  [disabled]="itensPaginados().paginaAtual === 1"
                  (click)="irParaPagina(itensPaginados().paginaAtual - 1)"
                >
                  ‚Üê Anterior
                </button>

                <div class="paginacao-numeros">
                  @for (pagina of gerarNumerosPagina(); track pagina) {
                    <button
                      class="btn-pagina"
                      [class.active]="pagina === itensPaginados().paginaAtual"
                      [class.disabled]="pagina === '...'"
                      (click)="pagina !== '...' && irParaPagina(+pagina)"
                    >
                      {{ pagina }}
                    </button>
                  }
                </div>

                <button
                  class="btn-paginacao"
                  [disabled]="itensPaginados().paginaAtual === itensPaginados().totalPaginas"
                  (click)="irParaPagina(itensPaginados().paginaAtual + 1)"
                >
                  Pr√≥xima ‚Üí
                </button>
              </div>
            }
          }
        </section>
      }
    </main>
  </div>
</div>

<!-- Modal de Movimenta√ß√£o -->
@if (mostrarModalMovimentacao()) {
  <div class="modal-overlay" (click)="fecharModalMovimentacao()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-titulo">
          {{ tipoMovimentacao() === 'sangria' ? 'üì§ Registrar Sangria' : 'üì• Registrar Suprimento' }}
        </h2>
        <button class="modal-fechar" (click)="fecharModalMovimentacao()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-grupo">
          <label class="form-label">Valor *</label>
          <input
            type="number"
            class="form-input"
            placeholder="0,00"
            step="0.01"
            min="0.01"
            [value]="valorMovimentacao()"
            (input)="valorMovimentacao.set(+$any($event.target).value)"
          />
        </div>

        <div class="form-grupo">
          <label class="form-label">Descri√ß√£o (opcional)</label>
          <input
            type="text"
            class="form-input"
            placeholder="Motivo da movimenta√ß√£o..."
            [value]="descricaoMovimentacao()"
            (input)="descricaoMovimentacao.set($any($event.target).value)"
          />
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancelar" (click)="fecharModalMovimentacao()">
          Cancelar
        </button>
        <button
          class="btn-confirmar"
          [class.btn-sangria]="tipoMovimentacao() === 'sangria'"
          [class.btn-suprimento]="tipoMovimentacao() === 'suprimento'"
          [disabled]="!valorMovimentacao() || valorMovimentacao()! <= 0"
          (click)="confirmarMovimentacao()"
        >
          Confirmar
        </button>
      </div>
    </div>
  </div>
}
